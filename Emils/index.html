<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8>
	<title>Emīla kosmiskā saikne</title>
	<link rel="shortcut icon" type="image/png" href="./img/favicon.ico"/>
	<style>
		* {
			margin: 0;
			padding: 0;
		}

		body {
			overflow: hidden;
		}

		canvas {
			width: 100%;
			height: 100%;
		}
	</style>
</head>
<body>
<canvas id="canvas"></canvas>

<script src="./js/three.min.js"></script>
<script src="./js/WebGL.js"></script>

<script src="./js/inflate.min.js"></script>
<script src="./js/FBXLoader.js"></script>

<script src="./js/effects/EffectComposer.js"></script>
<script src="./js/effects/ShaderPass.js"></script>
<script src="./js/effects/RenderPass.js"></script>
<script src="./js/effects/CopyShader.js"></script>

<script src="./js/effects/SepiaShader.js"></script>
<script src="./js/effects/DigitalGlitch.js"></script>
<script src="./js/effects/GlitchPass.js"></script>

<script src="./js/effects/AnaglyphEffect.js"></script>
<script>
	if (WEBGL.isWebGLAvailable() === false) {
		document.body.appendChild(WEBGL.getWebGLErrorMessage());
	}
	// PROPERTY NUMBERS
	const HOW_MANY_PLANTES = 2;
	const HOW_MANY_SPACE = 5;
	const SPEED_UP = getRandom(2);

	// GLOBAL VARIABLES
	var renderer, scene, camera, effect;
	var mixers = [];
	var clock = new THREE.Clock();
	var windowHalfX = window.innerWidth / 2;
	var windowHalfY = window.innerHeight / 2;
	var mouseX = 0, mouseY = 0;

	var emils, planet;

	function init() {
		// RENDERER
		renderer = new THREE.WebGLRenderer({
			canvas: document.getElementById('canvas'),
			antialias: true
		});
		renderer.setClearColor(0x000000);
		renderer.setPixelRatio(window.devicePixelRatio);
		renderer.setSize(window.innerWidth, window.innerHeight);

		camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1, 2000);
		camera.position.z = 180;
		scene = new THREE.Scene();

		// EFFECT
		effect = new THREE.AnaglyphEffect(renderer);
		effect.setSize(window.innerWidth, window.innerHeight);
	}

	function initMesh() {
		// // BACKGROUND
		// var texture = new THREE.TextureLoader().load( "img/space_"+ random_space +".jpg" );
		// scene.background = texture;

		// SKYBOX
		let skybox_path = './img/skybox/' + getRandom(HOW_MANY_SPACE) + '/';
		let skybox_urls = [
			skybox_path + 'right.png',
			skybox_path + 'left.png',
			skybox_path + 'top.png',
			skybox_path + 'bottom.png',
			skybox_path + 'front.png',
			skybox_path + 'back.png'
		];
		let skybox = new THREE.CubeTextureLoader().load(skybox_urls);
		skybox.format = THREE.RGBFormat;
		skybox.mapping = THREE.CubeReflectionMapping;
		scene.background = skybox;

		// LIGHTS
		let light = new THREE.AmbientLight(0xffffff, 0.5);
		scene.add(light);

		// POINT LIGHT
		let pointLight = new THREE.PointLight(0xffffff, 0.8);
		pointLight.position.z = 100;
		camera.add(pointLight);
		scene.add(camera);

		// PLANET
		let geometry = new THREE.SphereGeometry(30, 32, 32);
		let material = new THREE.MeshPhongMaterial();
		material.map = new THREE.TextureLoader().load('./img/planet_' + getRandom(HOW_MANY_PLANTES) + '.jpg');
		planet = new THREE.Mesh(geometry, material);
		planet.position.x = -1 * (20 + getRandom(30));
		scene.add(planet);

		// MODEL
		let loader = new THREE.FBXLoader();
		loader.load('./models/emils.fbx', function (object) {
			// object.mixer = new THREE.AnimationMixer(object);
			// mixers.push(object.mixer);
			// let action = object.mixer.clipAction(object.animations[0]);
			// action.play();
			object.traverse(function (child) {
				if (child.isMesh) {
					child.receiveShadow = true;
				}
			});
			object.scale.set(0.08, 0.08, 0.08);
			object.position.z = 100;
			object.rotation.y = 90;
			emils = object;
			scene.add(object);
		});
	}

	// RENDER
	function render() {
		requestAnimationFrame(render);
		effect.render(scene, camera);

		if (emils) {
			// var x = 0, y = 0;
			// var emils_position = toScreenPosition(emils, camera);
			// if (emils_position.x < 0) x = 1;
			// if (emils_position.x > window.innerWidth) x = -1;
			// if (emils_position.y < 0) y = 1;
			// if (emils_position.y > window.innerHeight) y = -1;
			// emils.position.x += (( mouseX - emils.position.x ) * 0.00001);
			// emils.position.y += ( -mouseY - emils.position.y ) * 0.00001;
			// emils.rotation.y += 0.03;
			// camera.lookAt( emils.position );
			camera.position.x += -(mouseX - camera.position.x) * 0.0001;
			camera.position.y += (mouseY - camera.position.y) * 0.0001;
			camera.lookAt(emils.position);
		}

		planet.rotation.y += 0.0003 * SPEED_UP;
		if (mixers.length > 0) {
			for (let i = 0; i < mixers.length; i++) {
				mixers[i].update(clock.getDelta());
			}
		}
	}

	function toScreenPosition(obj, camera) {
		let vector = new THREE.Vector3();

		let widthHalf = 0.5 * renderer.context.canvas.width;
		let heightHalf = 0.5 * renderer.context.canvas.height;

		obj.updateMatrixWorld();
		vector.setFromMatrixPosition(obj.matrixWorld);
		vector.project(camera);

		vector.x = (vector.x * widthHalf) + widthHalf;
		vector.y = -(vector.y * heightHalf) + heightHalf;

		return {
			x: vector.x,
			y: vector.y
		};
	}

	function getRandom(max) {
		return Math.floor(Math.random() * Math.floor(max)) + 1;
	}

	function onDocumentMouseMove(event) {
		mouseX = (event.clientX - windowHalfX);
		mouseY = (event.clientY - windowHalfY);
	}

	function onWindowResize() {
		windowHalfX = window.innerWidth / 2;
		windowHalfY = window.innerHeight / 2;
		camera.aspect = window.innerWidth / window.innerHeight;
		camera.updateProjectionMatrix();
		renderer.setSize(window.innerWidth, window.innerHeight);
		effect.setSize(window.innerWidth, window.innerHeight);
	}

	// EVENTS
	document.addEventListener('mousemove', onDocumentMouseMove, false);
	window.addEventListener('resize', onWindowResize, false);

	// FINAL FUNCTIONS
	init();
	initMesh();
	render();
</script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8>
    <title>Emīla kosmiskā saikne</title>
    <link rel="icon" href="img/favicon.ico" type="image/gif">
    <style>
        * { margin: 0; padding: 0;}
        body { overflow: hidden; }
        canvas { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script src="js/three.min.js"></script>
    <script src="js/MTLLoader.js"></script>
    <script src="js/OBJLoader.js"></script>
<script>
    // PROPERTY NUMBERS
	const HOW_MANY_PLANTES = 2;
	const HOW_MANY_SPACE = 5;

	// GLOBAL VARIABLES
    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 2;
    var mouseX = 0, mouseY = 0;
    var emils = null;
	var progress = document.createElement('div');
	var progressBar = document.createElement('div');

    // LOADER
	progress.appendChild(progressBar);
	document.body.appendChild(progress);
	var manager = new THREE.LoadingManager();
	manager.onProgress = function ( item, loaded, total ) {
		progressBar.style.width = (loaded / total * 100) + '%';
	};

    // RENDERER
    var renderer = new THREE.WebGLRenderer({canvas: document.getElementById('canvas'), antialias: true});
    renderer.setClearColor(0x000000);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize( window.innerWidth, window.innerHeight );

    var camera = new THREE.PerspectiveCamera( 30, window.innerWidth/window.innerHeight, 1, 1000 );
    camera.position.z = 180;
    var scene = new THREE.Scene();

    // // BACKGROUND
    // var texture = new THREE.TextureLoader().load( "img/space_"+ random_space +".jpg" );
    // scene.background = texture;

    // SKYBOX
    var skybox_path = 'img/skybox/'+ getRandom(HOW_MANY_SPACE) +'/';
    var skybox_urls = [
        skybox_path + 'right.png',
        skybox_path + 'left.png',
        skybox_path + 'top.png',
        skybox_path + 'bottom.png',
        skybox_path + 'front.png',
        skybox_path + 'back.png'
    ];
    var skybox = new THREE.CubeTextureLoader().load( skybox_urls );
    skybox.format = THREE.RGBFormat;
    skybox.mapping = THREE.CubeReflectionMapping;
    scene.background = skybox;

    // LIGHTS
    var light = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(light);

    // PLANET
    var geometry = new THREE.SphereGeometry(30, 32, 32);
    var material = new THREE.MeshPhongMaterial();
    material.map = new THREE.TextureLoader().load('img/planet_'+ getRandom(HOW_MANY_PLANTES) +'.jpg');
    var planet = new THREE.Mesh(geometry, material);
    planet.position.z = 0;
    scene.add(planet);

    // MODEL
    new THREE.MTLLoader().load('models/emils.mtl', function(materials) {
       materials.preload();
		new THREE.OBJLoader().setMaterials(materials).load('models/emils.obj', function(obj){
			obj.position.z = 160;
			obj.rotation.y += 90;
			emils = obj;
			scene.add(obj);
		});
    });

    // RENDER
    render();
    function render() {
        requestAnimationFrame( render );
        if(emils) {
            // var x = 0, y = 0;
            // var emils_position = toScreenPosition(emils, camera);
            // if (emils_position.x < 0) x = 1;
            // if (emils_position.x > window.innerWidth) x = -1;
            // if (emils_position.y < 0) y = 1;
            // if (emils_position.y > window.innerHeight) y = -1;
            // emils.position.x += (( mouseX - emils.position.x ) * 0.00001);
            // emils.position.y += ( -mouseY - emils.position.y ) * 0.00001;
            // emils.rotation.y += 0.03;
            // camera.lookAt( emils.position );
            camera.position.x += ( mouseX - camera.position.x ) * 0.00001;
            camera.position.y += ( mouseY - camera.position.y ) * 0.00001;
            camera.lookAt( emils.position );
        }

        planet.rotation.y += 0.0003;
        renderer.render( scene, camera );
    }

    function toScreenPosition(obj, camera) {
        var vector = new THREE.Vector3();

        var widthHalf = 0.5*renderer.context.canvas.width;
        var heightHalf = 0.5*renderer.context.canvas.height;

        obj.updateMatrixWorld();
        vector.setFromMatrixPosition(obj.matrixWorld);
        vector.project(camera);

        vector.x = ( vector.x * widthHalf ) + widthHalf;
        vector.y = - ( vector.y * heightHalf ) + heightHalf;

        return {
            x: vector.x,
            y: vector.y
        };
    }

    function onDocumentMouseMove( event ) {
        mouseX = ( event.clientX - windowHalfX  );
        mouseY = ( event.clientY - windowHalfY  );
    }

    function onWindowResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize( window.innerWidth, window.innerHeight );
    }

    function getRandom(max) {
        return Math.floor(Math.random() * Math.floor(max)) + 1;
    }

    // EVENTS
    document.addEventListener( 'mousemove', onDocumentMouseMove, false );
    window.addEventListener( 'resize', onWindowResize, false );
</script>
</body>
</html>